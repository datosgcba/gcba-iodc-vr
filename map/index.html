<!DOCTYPE html>
      <html lang="es">
  <head>
    <meta charset="utf-8">
    <title>IODC MAP</title>

      <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
                                                              
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    

    <script src="//d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="https://iodc-map.herokuapp.com/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>


    <link rel="stylesheet" href="https://gcba.github.io/BAstrap/bastrap/bastrap.css">
   
    <style>

      /* Make the chart container fill the page using CSS. */
      #chart {
        position: fixed;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
      }

        body{
            margin: 0;
            background-color: #96daea;
      }
  svg text, svg tspan{
            font-family: "CHANEWEI", Helvetica, Arial, sans-serif; 
      }

      .headerMap{
            position: fixed;
                width: 100%;
      }

      .headerMap .container{
        margin-left: 20px;
      }

      .headerMap h3{
        margin-bottom: 4px;
        margin-top: 14px
      }
      .gps{
        stroke:black;
        fill:red;
      }
    </style>
  </head>
  <body>
<header class="navbar navbar-primary navbar-top headerMap">
      
        <div class="container">
          <div class="row">
            <div class="col-md-2 col-xs-2 no_padding">
                <img src="https://gcba.github.io/BAstrap/images/ba_logo.png" style="margin-top: 14px">      
            </div>
            <div class="col-md-8 col-xs-8 no_padding">
      
              <h3 >Buenos Aires Data</h3>
              <p>Explor√° los datos abiertos de la Ciudad de una nueva manera<p>
            </div>
      
      
          </div>
        </div>
            
      </header>
    <div id="vis"></div>

    <script>
      // Extract the width and height that was computed by CSS.
      var chartDiv = document.getElementById("vis");
      var width = chartDiv.clientWidth;
      var height = chartDiv.clientHeight;


       $(function () {
          var socket = io('https://iodc-map.herokuapp.com');
          socket.on('user move', function(msg){
            updateViz(msg)
          });
        });

      //Esta es la base de los usuarios activos
      var users = [];

var updateViz = function(userMove){
        var found = false;
            users.map(function(user){
              if (user.userId== userMove.userId){
                user.idCity = userMove.idCity;
                user.pcia = userMove.pcia;
                user.level = userMove.level;
                found = true;
              }
            });
            if (!found){
              users.push(userMove);
            }
            updateCiudades();  
};
var svg, origin, gpsLayer, gps, timeTrans = 1000,circles;

    d3.queue()
          .defer(d3.xml, "mapa-arranged-full-notext3.svg")
          .defer(d3.csv, "metadatos.csv")
          .awaitAll(dibuja);

      

      function dibuja (error, results) {

          // IMPORTA EL SVG AL DOM
          var importedNode = document.importNode(results[0].documentElement, true);
                d3.select("div#vis")
                  .each(function() {
                    this.appendChild(importedNode);
                  })


        datos = results[1];

        svg = d3.select('svg');

        origin = svg.select("#centro");

        gpsLayer = svg.select("#ciudades").append("g").attr("id","gpsLayer");

  
          updateCiudades();

      }




          function updateCiudades(){
                    var gps = gpsLayer.selectAll("g")
                          .data(users);


                    gps.enter()
                          .append("g")
                          .attr("transform", function(d){
                                        return svg.select('[id="CENTRO"]').attr("transform");
                          })
                          .append("circle")
                          .attr("r",0)
                          .attr("class","gps")
                          .transition().duration(300).attr("r",5)
                          ;

                    gps.transition()
                        .duration(timeTrans)
                        .attr("transform", function(d,k){
                            if (d.idCity) return svg.select('[id="'+d.idCity+'"]').attr("transform");
                            if (d.pcia) return "translate(100,"+( 100 + k*100) + ')';
                            return svg.select('[id="CENTRO"]').attr("transform");

                          });
              }
      
    </script>
  </body>
</html>